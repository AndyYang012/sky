<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…‰é‡èº«é«˜æŸ¥è©¢</title>
  <style>
    :root{
      --bg1:#cfe9ff; --bg2:#ffffff; --card:#ffffff;
      --ink:#2c3e50; --muted:#6b7b8c;
      --accent:#2d8cf0; --accent-2:#1b6ec4;
      --warn:#e74c3c; --ok:#2ecc71;
      --shadow:0 8px 24px rgba(0,0,0,.08); --radius:14px; --bd:#d7e0ea;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Apple Color Emoji","Segoe UI Emoji",sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg1),var(--bg2))}
    h1{margin:16px 0 0;text-align:center;font-weight:800;letter-spacing:.06em}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0;border:1px solid var(--bd)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,textarea,select{width:100%;padding:12px 14px;border:1px solid var(--bd);border-radius:10px;outline:none;font-size:16px;background:#fafcff}
    textarea{resize:vertical}
    button{appearance:none;border:none;border-radius:10px;padding:12px 16px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button:hover{background:var(--accent-2)}
    .btn-ghost{background:#eef6ff;color:var(--accent-2)}
    .btn-outline{background:#fff;color:var(--accent-2);border:1px solid var(--accent-2)}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border:1px solid #e8edf3;padding:10px;text-align:center}
    th{background:#f7f9fc}
    .muted{color:var(--muted)} .warn{color:var(--warn);font-weight:700}
    .kpi{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .pill{flex:1 1 160px;border:1px dashed #cfe0ff;border-radius:12px;padding:10px 12px;background:#f7fbff}
    .pill .label{font-size:12px;color:#5b6b7c}
    .pill .val{font-size:18px;font-weight:800;letter-spacing:.02em}
    footer{padding:24px 0 48px;text-align:center;color:var(--muted);font-size:14px}
  </style>
</head>
<body>
  <div class="container">
    <h1>å…‰é‡èº«é«˜æŸ¥è©¢</h1>

    <!-- å–®ç­† -->
    <section class="card">
      <h2>å–®ä¸€é€£çµ</h2>
      <div class="row">
        <input id="singleInput" placeholder="è²¼ä¸Šç¶²å€ / o=... / token / åŸæ–‡" />
        <div class="row" style="gap:8px">
          <button onclick="parseSingle()">è§£æ</button>
          <button class="btn-ghost" onclick="clearSingle()">æ¸…é™¤</button>
        </div>
      </div>

      <details style="margin-top:8px">
        <summary>é¡¯ç¤ºè¨­å®š</summary>
        <div class="row">
          <div style="flex:1 1 160px">
            <label class="muted">å°æ•¸ä½æ•¸</label>
            <input id="decimals" type="number" min="0" max="10" step="1" value="6">
          </div>
          <div style="flex:1 1 160px">
            <label class="muted">å–®ä½ï¼ˆåƒ…é¡¯ç¤ºï¼‰</label>
            <select id="unit">
              <option value="cm" selected>cm</option>
              <option value="m">m</option>
              <option value="px">px</option>
            </select>
          </div>
        </div>
      </details>

      <div id="singleResult" style="margin-top:10px"></div>
    </section>

    <!-- æ‰¹æ¬¡ -->
    <section class="card">
      <h2>æ‰¹æ¬¡è§£æ</h2>
      <div class="row" style="align-items:center">
        <input type="file" id="fileInput" accept=".txt" style="width:auto">
        <div class="row" style="gap:8px">
          <button class="btn-outline" id="btnExport">åŒ¯å‡º CSV</button>
        </div>
      </div>
      <textarea id="batchInput" rows="6" placeholder="æ¯è¡Œè²¼ä¸€æ¢ç¶²å€ / o=... / token / åŸæ–‡"></textarea>
      <div class="row" style="gap:8px;margin-top:8px">
        <button onclick="parseBatch()">æ‰¹æ¬¡è§£æ</button>
        <button class="btn-ghost" onclick="clearBatch()">æ¸…é™¤</button>
      </div>

      <div class="kpi">
        <div class="pill"><div class="label">æœ‰æ•ˆç­†æ•¸</div><div class="val" id="kCnt">0</div></div>
        <div class="pill"><div class="label">å¹³å‡èº«é«˜</div><div class="val" id="kAvg">â€”</div></div>
        <div class="pill"><div class="label">æœ€é«˜</div><div class="val" id="kMax">â€”</div></div>
        <div class="pill"><div class="label">æœ€ä½</div><div class="val" id="kMin">â€”</div></div>
      </div>

      <div id="batchResult"></div>
    </section>

    <footer>
      è£½ä½œè€…ï¼šè¨€é™Œ ğŸ”¥ ï½œ æœ¬å·¥å…·èˆ‡ thatgamecompany ç„¡é—œï¼Œåƒ…ä¾›ç©å®¶äº¤æµèˆ‡å­¸ç¿’ä½¿ç”¨
    </footer>
  </div>

  <script>
    /* ========= å·¥å…· ========= */
    const $ = (id)=>document.getElementById(id);
    const getDec = ()=> Math.max(0, Math.min(10, parseInt(($('decimals')?.value||'6'),10)||6));
    const clampDec = (v,d)=> (isFinite(v)? Math.round(v*Math.pow(10,d))/Math.pow(10,d) : NaN);
    function copy(text){ if(navigator.clipboard?.writeText) return navigator.clipboard.writeText(text); const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }

    // å–å¾— tokenï¼ˆç¶²å€ / hash / ç´” token / åŸæ–‡ï¼‰
    function getToken(input){
      if(!input) return '';
      let s = input.trim();
      try{ s = decodeURIComponent(s); }catch{}
      try{
        const u = new URL(s);
        const q = u.searchParams.get('o') || u.searchParams.get('O');
        if (q) return q;
        if (u.hash && /o=/.test(u.hash)){
          const m = u.hash.match(/o=([A-Za-z0-9\-_+=/]+)/);
          if (m) return m[1];
        }
      }catch{}
      const m2 = s.match(/(?:\bo=)([A-Za-z0-9\-_+=/]+)/);
      if (m2) return m2[1];
      if (/^[A-Za-z0-9\-_+=/]+$/.test(s)) return s;
      return s; // å·²è§£ç¢¼åŸæ–‡
    }

    // base64url â†’ bytes
    function b64urlToBytes(b64url){
      let b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
      const pad = b64.length % 4; if(pad) b64 += '='.repeat(4-pad);
      const bin = atob(b64);
      const out = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
      return out;
    }
    // bytes â†’ string
    function bytesToString(bytes){
      try{ return new TextDecoder('utf-8',{fatal:false}).decode(bytes); }
      catch{ return Array.from(bytes).map(c=>String.fromCharCode(c)).join(''); }
    }

    // å¾å­—ä¸²æ’ˆå‡º height/scaleï¼ˆå…è¨±è² è™Ÿ/ç§‘å­¸è¨˜è™Ÿï¼‰
    function pickHeightScale(text){
      if(!text) return null;
      const num = '(-?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)';
      let mh = text.match(new RegExp('["#]?height"\\s*:\\s*'+num,'i'));
      let ms = text.match(new RegExp('"scale"\\s*:\\s*'+num,'i'));
      if(!mh) mh = text.match(new RegExp('[h#]eight\\s*[:\\s]\\s*'+num,'i'));
      if(!ms) ms = text.match(new RegExp('\\bscale\\s*[:\\s]\\s*'+num,'i'));
      if(!mh || !ms) return null;
      const h = parseFloat(mh[1]), s = parseFloat(ms[1]);
      if(!isFinite(h)||!isFinite(s)) return null;
      return {height:h, scale:s};
    }

    // å˜—è©¦è§£æï¼ˆä¸€è¡Œï¼‰
    function parseLine(line){
      if(!line) return null;
      let cur = getToken(line);

      // å·²æ˜¯åŸæ–‡
      if(/height|scale/i.test(cur) && !/^[A-Za-z0-9\-_+=/]+$/.test(cur)){
        const r0 = pickHeightScale(cur);
        if (r0) return r0;
      }

      // Base64URL è‡³å¤š 2 å±¤
      for(let i=0;i<2;i++){
        try{
          const text = bytesToString(b64urlToBytes(cur));
          const r = pickHeightScale(text);
          if (r) return r;
          cur = text;
        }catch{ break; }
      }
      return null;
    }

    /* ========= è¨ˆç®—èˆ‡æ¸²æŸ“ ========= */
    const calc = (H,S)=> 7.6 - 8.3*S - 3*H;

    function renderSingle(h,s){
      const d = getDec();
      const now = calc(h,s), top = calc(2,s), low = calc(-2,s);
      return `
        <table>
          <tr><th>æ¬„ä½</th><th>æ•¸å€¼</th></tr>
          <tr><td>height</td><td>${h}</td></tr>
          <tr><td>scale</td><td>${s}</td></tr>
          <tr><td>èº«é«˜</td><td>${now.toFixed(d)}</td></tr>
          <tr><td>æœ€é«˜ (h=2)</td><td>${top.toFixed(d)}</td></tr>
          <tr><td>æœ€ä½ (h=-2)</td><td>${low.toFixed(d)}</td></tr>
        </table>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="btn-outline" onclick="copy('${now.toFixed(d)}')">è¤‡è£½èº«é«˜</button>
        </div>
        <p class="muted">æç¤ºï¼šæ–°å¸³è™Ÿè‹¥æœªåœ¨è¡£æ«ƒå­˜æª”ï¼Œheight/scale å¯èƒ½ç•°å¸¸ï¼Œè«‹åœ¨è¡£æ«ƒåˆ‡æ›èº«é«˜å¾Œé‡ç”¢ QRã€‚</p>
      `;
    }

    function parseSingle(){
      const input = $('singleInput').value.trim();
      const res = parseLine(input);
      $('singleResult').innerHTML = res ? renderSingle(res.height,res.scale) : '<p class="warn">âš ï¸ ç„¡æ•ˆæ•¸å€¼ï¼Œç„¡æ³•è¨ˆç®—èº«é«˜</p>';
    }
    function clearSingle(){ $('singleInput').value=''; $('singleResult').innerHTML=''; }

    /* ========= æ‰¹æ¬¡ ========= */
    function parseBatch(){
      const lines = $('batchInput').value.split('\n').map(s=>s.trim()).filter(Boolean);
      let html = '<table><tr><th>#</th><th>height</th><th>scale</th><th>èº«é«˜</th><th>æœ€é«˜(h=2)</th><th>æœ€ä½(h=-2)</th></tr>';
      let n=0, sum=0, vmin=Infinity, vmax=-Infinity, d=getDec();

      lines.forEach((line,i)=>{
        const r = parseLine(line);
        if (r){
          const now = calc(r.height, r.scale);
          const top = calc(2, r.scale);
          const low = calc(-2, r.scale);
          html += `<tr>
            <td>${i+1}</td>
            <td>${r.height}</td>
            <td>${r.scale}</td>
            <td>${now.toFixed(d)}</td>
            <td>${top.toFixed(d)}</td>
            <td>${low.toFixed(d)}</td>
          </tr>`;
          n++; sum += now; if(now<vmin) vmin=now; if(now>vmax) vmax=now;
        }else{
          html += `<tr><td>${i+1}</td><td colspan="5" class="warn">âš ï¸ ç„¡æ•ˆæ•¸å€¼</td></tr>`;
        }
      });

      html += '</table>';
      $('batchResult').innerHTML = html;
      $('kCnt').textContent = String(n);
      $('kAvg').textContent = n? clampDec(sum/n,d).toFixed(d) : 'â€”';
      $('kMax').textContent = isFinite(vmax)? vmax.toFixed(d) : 'â€”';
      $('kMin').textContent = isFinite(vmin)? vmin.toFixed(d) : 'â€”';
    }

    function clearBatch(){
      $('batchInput').value=''; $('batchResult').innerHTML='';
      $('kCnt').textContent='0'; $('kAvg').textContent='â€”';
      $('kMax').textContent='â€”'; $('kMin').textContent='â€”';
    }

    // åŒ¯å…¥ txtï¼ˆæ¯è¡Œä¸€ç­†ï¼‰
    $('fileInput').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const txt = await f.text(); $('batchInput').value = txt; parse
