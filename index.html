<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…‰é‡èº«é«˜æŸ¥è©¢</title>
  <style>
    :root{
      --bg1:#cfe9ff;
      --bg2:#ffffff;
      --card:#ffffff;
      --ink:#2c3e50;
      --muted:#6b7b8c;
      --accent:#2d8cf0;
      --accent-2:#1b6ec4;
      --warn:#e74c3c;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Apple Color Emoji","Segoe UI Emoji",sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    h1{margin:16px 0 0;text-align:center;font-weight:800;letter-spacing:.06em}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
      margin:16px 0;
    }
    .guide figure{margin:0}
    .guide img{width:100%;border-radius:12px;display:block}
    .guide figcaption{color:var(--muted);font-size:14px;text-align:center;margin-top:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,textarea{
      width:100%;padding:12px 14px;border:1px solid #d7e0ea;border-radius:10px;
      outline:none;font-size:16px;background:#fafcff;
    }
    textarea{resize:vertical}
    button{
      appearance:none;border:none;border-radius:10px;padding:12px 16px;
      background:var(--accent);color:#fff;font-weight:700;cursor:pointer
    }
    button:hover{background:var(--accent-2)}
    .btn-ghost{background:#eef6ff;color:var(--accent-2)}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border:1px solid #e8edf3;padding:10px;text-align:center}
    th{background:#f7f9fc}
    .muted{color:var(--muted)}
    .warn{color:var(--warn);font-weight:700}
    footer{padding:24px 0 48px;text-align:center;color:var(--muted);font-size:14px}
  </style>
</head>
<body>
  <div class="container">
    <h1>å…‰é‡èº«é«˜æŸ¥è©¢</h1>

    <!-- æ•™å­¸ -->
    <section class="card guide">
      <h2>ä½¿ç”¨æ•™å­¸</h2>
      <figure>
        <img src="IMG_3171.jpeg" alt="æ•™å­¸ç•«é¢">
        <figcaption>æ­¥é©Ÿ1ï¼šé–‹å•ŸéŠæˆ² â†’ å¸³è™Ÿè³‡è¨Š â†’ é¡¯ç¤º QRcode</figcaption>
      </figure>
      <p>æ­¥é©Ÿ2ï¼šæƒæ QRcodeï¼Œè¤‡è£½ç¶²å€</p>
      <p>æ­¥é©Ÿ3ï¼šè²¼åˆ°ä¸‹æ–¹è¼¸å…¥æ¡†ï¼Œé»ã€Œè§£æã€</p>
    </section>

    <!-- å–®ç­† -->
    <section class="card">
      <h2>å–®ä¸€é€£çµ</h2>
      <div class="row">
        <input id="singleInput" placeholder="è²¼ä¸Šç¶²å€ / o=... / token" />
        <div class="row" style="gap:8px">
          <button onclick="parseSingle()">è§£æ</button>
          <button class="btn-ghost" onclick="clearSingle()">æ¸…é™¤</button>
        </div>
      </div>
      <div id="singleResult" style="margin-top:10px"></div>
    </section>

    <!-- æ‰¹æ¬¡ -->
    <section class="card">
      <h2>æ‰¹æ¬¡è§£æ</h2>
      <textarea id="batchInput" rows="5" placeholder="æ¯è¡Œè²¼ä¸€æ¢ç¶²å€ / o=... / token"></textarea>
      <div class="row" style="gap:8px;margin-top:8px">
        <button onclick="parseBatch()">æ‰¹æ¬¡è§£æ</button>
        <button class="btn-ghost" onclick="clearBatch()">æ¸…é™¤</button>
      </div>
      <div id="batchResult"></div>
    </section>

    <footer>
      è£½ä½œè€…ï¼šè¨€é™Œ ğŸ”¥ ï½œ æ­¤ç¶²é æŒçºŒæ›´æ–°<br>
      æœ¬å·¥å…·èˆ‡ thatgamecompany ç„¡é—œï¼Œåƒ…ä¾›ç©å®¶äº¤æµèˆ‡å­¸ç¿’ä½¿ç”¨
    </footer>
  </div>

  <script>
    /* =========================
       è§£æå·¥å…·ï¼ˆå¥å£¯ç‰ˆï¼‰
       ========================= */

    // å¾è¼¸å…¥å–å¾— tokenï¼ˆç¶²å€ / o=... / ç´” token / å·²è§£ç¢¼åŸæ–‡ éƒ½å¯ï¼‰
    function getToken(input) {
      const s = input.trim();

      // 1) URL ?o=
      try {
        const u = new URL(s);
        const q = u.searchParams.get('o');
        if (q) return q;
      } catch(e) {}

      // 2) æ–‡æœ¬ä¸­å« o=
      const m = s.match(/(?:\bo=)([A-Za-z0-9\-_+=/]+)/);
      if (m) return m[1];

      // 3) ç´” token
      if (/^[A-Za-z0-9\-_+=/]+$/.test(s)) return s;

      // 4) å¯èƒ½æ˜¯å·²ç¶“è§£é–‹çš„åŸæ–‡ï¼ˆå« height/scaleï¼‰
      return s;
    }

    // base64url â†’ bytes
    function b64urlToBytes(b64url) {
      let b64 = b64url.replace(/-/g, '+').replace(/_/g, '/');
      const pad = b64.length % 4;
      if (pad) b64 += '='.repeat(4 - pad);
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
      return bytes;
    }

    // bytes â†’ stringï¼ˆUTF-8ï¼Œå¤±æ•—é€€ Latin-1ï¼‰
    function bytesToString(bytes) {
      try {
        return new TextDecoder('utf-8', {fatal:false}).decode(bytes);
      } catch {
        return Array.from(bytes).map(c => String.fromCharCode(c)).join('');
      }
    }

    // åœ¨é›œè¨Šä¸­æ’ˆå‡º height / scale
    function pickHeightScale(text) {
      // å¸¸è¦‹ï¼š "height":1.234 , "scale":0.02
      let mh = text.match(/["#]?height"\s*:\s*(-?\d+(?:\.\d+)?(?:e[-+]?\d+)?)/i);
      let ms = text.match(/"scale"\s*:\s*(-?\d+(?:\.\d+)?(?:e[-+]?\d+)?)/i);

      // å¯¬é¬†ï¼š height 1.234 / scale 0.02 / #eight:1.23
      if (!mh) mh = text.match(/[h#]eight\s*[:\s]\s*(-?\d+(?:\.\d+)?(?:e[-+]?\d+)?)/i);
      if (!ms) ms = text.match(/\bscale\s+(-?\d+(?:\.\d+)?(?:e[-+]?\d+)?)/i);

      if (!mh || !ms) return null;

      const h = parseFloat(mh[1]);
      const s = parseFloat(ms[1]);
      if (!isFinite(h) || !isFinite(s)) return null;

      return {height:h, scale:s};
    }

    // é€šç”¨è§£æï¼šä¸€è¡Œè¼¸å…¥ â†’ {height, scale} æˆ– null
    function parseLine(line) {
      if (!line) return null;
      const tokenOrWhole = getToken(decodeURIComponent(line));

      // å·²æ˜¯åŸæ–‡ä¸”å« height/scale
      if (/height|scale/i.test(tokenOrWhole) && !/^[A-Za-z0-9\-_+=/]+$/.test(tokenOrWhole)) {
        return pickHeightScale(tokenOrWhole);
      }
      // ç•¶ä½œ base64url è§£
      try {
        const bytes = b64urlToBytes(tokenOrWhole);
        const text  = bytesToString(bytes);
        return pickHeightScale(text);
      } catch {
        return null;
      }
    }

    /* =========================
       è¨ˆç®—èˆ‡æ¸²æŸ“
       ========================= */

    // èº«é«˜å…¬å¼ï¼š7.6 âˆ’ 8.3Ã—scale âˆ’ 3Ã—height
    const calc = (H,S) => 7.6 - 8.3*S - 3*H;

    function renderResult(res){
      if (!res) return `<p class="warn">âš ï¸ ç„¡æ•ˆæ•¸å€¼ï¼Œç„¡æ³•è¨ˆç®—èº«é«˜</p>`;
      const {height:h,scale:s} = res;
      if (!isFinite(h)||!isFinite(s)) return `<p class="warn">âš ï¸ ç„¡æ•ˆæ•¸å€¼ï¼Œç„¡æ³•è¨ˆç®—èº«é«˜</p>`;

      const now = calc(h,s);
      const topVal = calc(2,s);   // å›ºå®š h=2
      const lowVal = calc(-2,s);  // å›ºå®š h=-2

      return `
        <table>
          <tr><th>æ¬„ä½</th><th>æ•¸å€¼</th></tr>
          <tr><td>height</td><td>${h}</td></tr>
          <tr><td>scale</td><td>${s}</td></tr>
          <tr><td>èº«é«˜</td><td>${now.toFixed(6)}</td></tr>
          <tr><td>æœ€é«˜ (h=2)</td><td>${topVal.toFixed(6)}</td></tr>
          <tr><td>æœ€ä½ (h=-2)</td><td>${lowVal.toFixed(6)}</td></tr>
        </table>
        <p class="muted">âš ï¸ æé†’ï¼šæ–°å¸³è™Ÿè‹¥å°šæœªé€²è¡£æ«ƒå­˜æª”ï¼Œheight/scale å¯èƒ½æ˜¯ç•°å¸¸å€¼ï¼Œè«‹é€²è¡£æ«ƒåˆ‡æ›ä¸€æ¬¡èº«é«˜å¾Œé‡ç”¢ QRã€‚</p>
      `;
    }

    /* =========================
       å–®ç­†
       ========================= */
    function parseSingle(){
      const input = document.getElementById('singleInput').value.trim();
      const res = parseLine(input);
      document.getElementById('singleResult').innerHTML = renderResult(res);
    }
    function clearSingle(){
      document.getElementById('singleInput').value='';
      document.getElementById('singleResult').innerHTML='';
    }

    /* =========================
       æ‰¹æ¬¡
       ========================= */
    function parseBatch(){
      const lines = document.getElementById('batchInput').value
        .split('\n').map(s=>s.trim()).filter(Boolean);

      let html = '<table><tr><th>#</th><th>height</th><th>scale</th><th>èº«é«˜</th><th>æœ€é«˜(h=2)</th><th>æœ€ä½(h=-2)</th></tr>';

      lines.forEach((line,i)=>{
        const r = parseLine(line);
        if (r){
          const now = calc(r.height,r.scale);
          const topVal = calc(2,r.scale);
          const lowVal = calc(-2,r.scale);
          html += `<tr>
            <td>${i+1}</td>
            <td>${r.height}</td>
            <td>${r.scale}</td>
            <td>${now.toFixed(6)}</td>
            <td>${topVal.toFixed(6)}</td>
            <td>${lowVal.toFixed(6)}</td>
          </tr>`;
        }else{
          html += `<tr><td>${i+1}</td><td colspan="5" class="warn">âš ï¸ ç„¡æ•ˆæ•¸å€¼</td></tr>`;
        }
      });

      html += '</table>';
      document.getElementById('batchResult').innerHTML = html;
    }
    function clearBatch(){
      document.getElementById('batchInput').value='';
      document.getElementById('batchResult').innerHTML='';
    }
  </script>
</body>
</html>