<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>光遇身高查詢</title>
  <style>
    :root{
      --bg1:#cfe9ff; --bg2:#ffffff; --card:#ffffff;
      --ink:#2c3e50; --muted:#6b7b8c;
      --accent:#2d8cf0; --accent-2:#1b6ec4;
      --warn:#e74c3c; --shadow:0 8px 24px rgba(0,0,0,.08); --radius:14px;
      --bd:#d7e0ea;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Apple Color Emoji","Segoe UI Emoji",sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg1),var(--bg2))}
    h1{margin:16px 0 0;text-align:center;font-weight:800;letter-spacing:.06em}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0;border:1px solid var(--bd)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,textarea{width:100%;padding:12px 14px;border:1px solid var(--bd);border-radius:10px;outline:none;font-size:16px;background:#fafcff}
    button{appearance:none;border:none;border-radius:10px;padding:12px 16px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button:hover{background:var(--accent-2)}
    .btn-ghost{background:#eef6ff;color:var(--accent-2)}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border:1px solid #e8edf3;padding:10px;text-align:center}
    th{background:#f7f9fc}
    .muted{color:var(--muted)} .warn{color:var(--warn);font-weight:700}
    .error-box{background:#fff3f3;border:1px solid #f5b5b5;color:#b20000;padding:10px;border-radius:10px;margin-top:10px;font-size:14px;white-space:pre-wrap}
    .guide figure{margin:0}
    .guide img{width:100%;border-radius:12px;display:block}
    .guide figcaption{color:var(--muted);font-size:14px;text-align:center;margin-top:8px}
    footer{padding:24px 0 48px;text-align:center;color:var(--muted);font-size:14px}
  </style>
</head>
<body>
  <div class="container">
    <h1>光遇身高查詢</h1>

    <!-- 使用教學 -->
    <section class="card guide">
      <h2>使用教學</h2>
      <figure>
        <img src="IMG_3171.jpeg" alt="教學畫面" loading="lazy">
        <figcaption>步驟1：開啟遊戲 → 帳號資訊 → 顯示 QRcode</figcaption>
      </figure>
      <p>步驟2：掃描 QRcode，複製網址（或 QR 內容內的 <code>o=...</code> token）。</p>
      <p>步驟3：貼到下方輸入框，點「解析」。</p>
    </section>

    <!-- 單一連結 -->
    <section class="card">
      <h2>單一連結</h2>
      <div class="row">
        <input id="singleInput" placeholder="貼上網址 / o=... / token / 原文" />
        <div class="row" style="gap:8px">
          <button onclick="parseSingle()">解析</button>
          <button class="btn-ghost" onclick="clearSingle()">清除</button>
        </div>
      </div>
      <div id="singleResult" style="margin-top:10px"></div>
    </section>

    <!-- 多條連結 -->
    <section class="card">
      <h2>多條連結（每行一條）</h2>
      <textarea id="batchInput" rows="6" placeholder="每行貼一條網址 / o=... / token"></textarea>
      <div class="row" style="gap:8px;margin-top:8px">
        <button onclick="parseBatch()">批次解析</button>
        <button class="btn-ghost" onclick="clearBatch()">清除</button>
      </div>
      <div id="batchResult"></div>
    </section>

    <footer>
      製作者：言陌 🔥 ｜ 本工具與 thatgamecompany 無關，僅供玩家交流與學習使用
    </footer>
  </div>

  <script>
    function renderError(msg, detail){
      return `<div class="error-box"><b>${msg}</b>\n${detail||''}</div>`;
    }

    function getToken(input, log){
      if(!input) return '';
      let s = String(input).trim();
      try{ s = decodeURIComponent(s); }catch(e){ log.push("decodeURIComponent 失敗: "+e); }
      try{
        const u = new URL(s);
        const q = u.searchParams.get('o') || u.searchParams.get('O');
        if (q) return q;
        if (u.hash){
          const m = u.hash.match(/o=([A-Za-z0-9\-_+=/]+)/);
          if (m) return m[1];
        }
      }catch(e){ log.push("URL parse 失敗: "+e); }
      const m2 = s.match(/(?:^|[?#&\s])o=([A-Za-z0-9\-_+=/]+)/);
      if (m2) return m2[1];
      if (/^[A-Za-z0-9\-_+=/]+$/.test(s)) return s;
      return s;
    }

    function b64urlToBytes(b64url){
      let clean = (b64url||'').replace(/[^A-Za-z0-9\-_+=/]/g,'');
      let b64 = clean.replace(/-/g,'+').replace(/_/g,'/');
      const pad = b64.length % 4; if (pad) b64 += '='.repeat(4-pad);
      const bin = atob(b64);
      const out = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
      return out;
    }
    function bytesToString(bytes){
      try{ return new TextDecoder('utf-8',{fatal:false}).decode(bytes); }
      catch{ return Array.from(bytes).map(c=>String.fromCharCode(c)).join(''); }
    }

    function pickHeightScale(text){
      if (!text) return null;
      const num = '(-?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)';
      let mh = text.match(new RegExp('["#]?height"\\s*[:=]\\s*'+num,'i'));
      let ms = text.match(new RegExp('"scale"\\s*[:=]\\s*'+num,'i'));
      if(!mh || !ms) return null;
      return {height:parseFloat(mh[1]), scale:parseFloat(ms[1])};
    }

    function parseLine(line, log){
      if (!line) return null;
      let cur = getToken(line, log);

      if (/height|scale/i.test(cur) && !/^[A-Za-z0-9\-_+=/]+$/.test(cur)){
        const r0 = pickHeightScale(cur);
        if (r0) return r0;
        log.push("原文內找不到 height/scale");
      }

      for (let i=0; i<4; i++){
        try{
          const txt = bytesToString(b64urlToBytes(cur));
          const r = pickHeightScale(txt);
          if (r) return r;
          cur = txt;
        }catch(e){ log.push("base64 第"+(i+1)+"層失敗: "+e); break; }
      }

      try{
        const again = decodeURIComponent(cur);
        const txt2 = bytesToString(b64urlToBytes(again));
        const r2 = pickHeightScale(txt2);
        if (r2) return r2;
      }catch(e){ log.push("decodeURIComponent 後再解碼失敗: "+e); }

      return null;
    }

    const calc = (H,S)=> 7.6 - 8.3*S - 3*H;

    function renderResult(res, log){
      if(!res){
        return renderError("⚠️ 無效數值，無法計算身高", log.join("\n"));
      }
      const {height,scale} = res;
      const now = calc(height,scale);
      const top = calc(2,scale);
      const low = calc(-2,scale);
      return `
        <table>
          <tr><th>欄位</th><th>數值</th></tr>
          <tr><td>height</td><td>${height}</td></tr>
          <tr><td>scale</td><td>${scale}</td></tr>
          <tr><td>身高</td><td>${now.toFixed(10)}</td></tr>
          <tr><td>最高(h=2)</td><td>${top.toFixed(10)}</td></tr>
          <tr><td>最低(h=-2)</td><td>${low.toFixed(10)}</td></tr>
        </table>
        <div class="error-box">${log.length?log.join("\n"):"無錯誤"}</div>
      `;
    }

    function parseSingle(){
      const log=[];
      const input = document.getElementById('singleInput').value.trim();
      const res = parseLine(input, log);
      document.getElementById('singleResult').innerHTML = renderResult(res, log);
    }
    function clearSingle(){document.getElementById('singleInput').value='';document.getElementById('singleResult').innerHTML='';}

    function parseBatch(){
      const lines=document.getElementById('batchInput').value.split('\n').map(s=>s.trim()).filter(Boolean);
      let html='<table><tr><th>#</th><th>height</th><th>scale</th><th>身高</th><th>最高(h=2)</th><th>最低(h=-2)</th><th>錯誤</th></tr>';
      lines.forEach((line,i)=>{
        const log=[]; const r=parseLine(line,log);
        if(r){
          const now=calc(r.height,r.scale), top=calc(2,r.scale), low=calc(-2,r.scale);
          html+=`<tr>
            <td>${i+1}</td><td>${r.height}</td><td>${r.scale}</td>
            <td>${now.toFixed(6)}</td><td>${top.toFixed(6)}</td><td>${low.toFixed(6)}</td>
            <td style="text-align:left;font-size:12px">${log.join("<br>")||"—"}</td>
          </tr>`;
        }else{
          html+=`<tr><td>${i+1}</td><td colspan="6" class="warn">⚠️ 無效數值<br>${log.join("<br>")}</td></tr>`;
        }
      });
      html+='</table>'; document.getElementById('batchResult').innerHTML=html;
    }
    function clearBatch(){document.getElementById('batchInput').value='';document.getElementById('batchResult').innerHTML='';}
  </script>
</body>
</html>